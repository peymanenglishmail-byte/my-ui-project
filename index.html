<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // --- Tab switching ---
  function openTab(evt, tabName) {
    document.querySelectorAll(".tabcontent").forEach(tc => tc.style.display = "none");
    document.querySelectorAll(".tablink").forEach(tl => tl.classList.remove("active"));
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add("active");
  }

  // --- State variables ---
  let testRunning = false;
  let cylinderUp = false;
  let totalCycles = 0;
  let currentCycle = 0;
  let forwardDuration = 0;
  let backwardDuration = 0;
  let stations = [false, false, false, false, false];
  let errorMessage = 0;

  // --- Update UI ---
  function updateUI() {
    // Power Icon (Test ON/OFF)
    const powerIcon = document.getElementById("powerIcon");
    const powerLabel = document.getElementById("powerLabel");
    if (testRunning) {
      powerIcon.className = "power-icon power-on";
      powerLabel.textContent = "Test ON";
    } else {
      powerIcon.className = "power-icon power-off";
      powerLabel.textContent = "Test OFF";
    }

    // Error Panel
    const errorPanel = document.querySelector(".error-panel");
    const errorLabel = document.getElementById("errorLabel");
    if (errorMessage == 0) {
      errorPanel.style.display = "none";
    } else {
      errorPanel.style.display = "flex";
      switch(errorMessage) {
        case 1: errorLabel.textContent = "Station 1 detached"; break;
        case 2: errorLabel.textContent = "Station 2 detached"; break;
        case 3: errorLabel.textContent = "Station 3 detached"; break;
        case 4: errorLabel.textContent = "Station 4 detached"; break;
        case 5: errorLabel.textContent = "Station 5 detached"; break;
        default: errorLabel.textContent = "Unknown Error";
      }
    }

    // Cylinder
    const cyl = document.getElementById("cylinder");
    const cylLabel = document.getElementById("cylinderLabel");
    if (cylinderUp) {
      cyl.textContent = "⬆️";
      cylLabel.textContent = "Cylinder Up";
    } else {
      cyl.textContent = "⬇️";
      cylLabel.textContent = "Cylinder Down";
    }

    // Cycles
    document.getElementById("totalCycles").textContent = totalCycles;
    document.getElementById("currentCycle").textContent = currentCycle;
    document.getElementById("forwardDuration").textContent = forwardDuration;
    document.getElementById("backwardDuration").textContent = backwardDuration;

    // Update bargraph fill
    const barFill = document.getElementById("barFill");
    const barPercent = document.getElementById("barPercent");
    if (totalCycles > 0) {
      const percent = Math.min(100, (currentCycle / totalCycles) * 100);
      barFill.style.width = percent + "%";
      barPercent.textContent = Math.round(percent) + "%";
    } else {
      barFill.style.width = "0%";
      barPercent.textContent = "0%";
    }

    // Stations
    stations.forEach((active, idx) => {
      const el = document.getElementById(`station${idx+1}`);
      el.className = active ? "indicator led-on" : "indicator led-off";
    });
  }

  // --- MQTT Setup ---
  const broker = "wss://test.mosquitto.org:8081"; // WebSocket TLS port
  const topic = "esp32/peyman/test";
  let client;

  function initMQTT() {
    console.log("Connecting to MQTT broker...");
    client = mqtt.connect(broker);

    client.on("connect", () => {
      console.log("MQTT connected");
      client.subscribe(topic, (err) => {
        if (!err) {
          console.log("Subscribed to", topic);
        } else {
          console.error("Subscribe error:", err);
        }
      });
    });

    client.on("message", (receivedTopic, message) => {
      if (receivedTopic === topic) {
        try {
          const dat = JSON.parse(message.toString());

          if ("testRunning" in data) testRunning = data.testRunning;
          if ("cylinderUp" in data) cylinderUp = data.cylinderUp;
          if ("totalCycles" in data) totalCycles = data.totalCycles;
          if ("currentCycle" in data) currentCycle = data.currentCycle;
          if ("forwardDuration" in data) forwardDuration = data.forwardDuration;
          if ("backwardDuration" in data) backwardDuration = data.backwardDuration;
          if ("stations" in data && Array.isArray(data.stations)) stations = data.stations;
          if ("errorMessage" in data) errorMessage = data.errorMessage;
          updateUI();
        } catch (err) {
          console.error("Invalid JSON:", message.toString());
        }
      }
    });
    client.on("error", (err) => {
      console.error("MQTT error:", err);
    });

    client.on("close", () => {
      console.log("MQTT connection closed, retrying...");
      setTimeout(initMQTT, 3000);
    });
  }

  // --- Initialize ---
  window.addEventListener("load", () => {
    initMQTT();
    updateUI();
  });
</script>
