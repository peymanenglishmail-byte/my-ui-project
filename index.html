<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>W_Lab_Monitor</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: #f0f2f5;
      color: #333;
    }
.power-wrapper {
  display: flex;
  align-items: center;
  gap: 15px;   /* space between power icon and error panel */
  margin: 10px 0;
}
    .tabs {
      display: flex;
      background: linear-gradient(90deg, #0066cc, #004080);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .tabs button {
      flex: 1;
      padding: 14px;
      border: none;
      background: transparent;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .tabs button.active {
      background: rgba(255,255,255,0.2);
    }

    .tabcontent {
      display: none;
      padding: 25px;
      background: white;
      border-radius: 8px;
      margin: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h2 {
      margin-top: 0;
      color: #004080;
      border-bottom: 2px solid #0066cc;
      padding-bottom: 8px;
    }

    /* Power icon for Test ON/OFF */
    .power-icon {
      font-size: 28px;
      margin-right: 10px;
      transition: color 0.3s;
    }
    .power-off { color: #e74c3c; }   /* red */
    .power-on { color: #2ecc71; }    /* green */

    .indicator {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .led-off { background: #e74c3c; }
    .led-on { background: #2ecc71; }

    .panel {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 15px 0;
      background: #fafafa;
      border-radius: 6px;
    }

    .cylinder {
      font-size: 48px;
      margin: 10px;
    }

    .error-panel {
      border: 1px solid #f1c40f;
      padding: 6px 10px;
      background: #fff9e6;
      display: none; /* hidden by default */
      align-items: center;
      gap: 6px;
      font-size: 13px;
      border-radius: 4px;
    }
    .error-icon {
      font-size: 18px;
      color: #f39c12;
    }

    .cylinder-wrapper {
      display: flex;
      align-items: center;
      gap: 20px;
      margin: 15px 0;
    }

        /* Bargraph styles */
    .bargraph-container {
      display: inline-block;
      width: 200px;
      height: 16px;
      background: #ddd;
      border-radius: 8px;
      margin-left: 10px;
      overflow: hidden;
      vertical-align: middle;
    }
    .bargraph-fill {
      height: 100%;
      width: 0%;
      background: #2ecc71;
      transition: width 0.3s;
    }
    .bargraph-percent {
      display: inline-block;
      margin-left: 8px;
      font-weight: bold;
      color: #333;
    }

  </style>
</head>
<body>

<div class="tabs">
  <button class="tablink active" onclick="openTab(event,'tab1')">DW String</button>
  <button class="tablink" onclick="openTab(event,'tab2')">Drain Pump</button>
  <button class="tablink" onclick="openTab(event,'tab3')">Tab 3</button>
</div>

<div id="tab1" class="tabcontent" style="display:block;">
  <h2>DW String Test Machine</h2>
   <!-- Power Indicator + Error Panel side by side -->
<div class="power-wrapper">
  <div>
    <span id="string_powerIcon" class="string_power-icon power-off">⏻</span>
    <span id="string_powerLabel">Test OFF</span>
  </div>
  <div class="string_error-panel">
    <span class="error-icon">⚠️</span>
    <span id="string_errorLabel">No Errors</span>
  </div>
</div>

  <!-- Panels -->
  <div class="panel">
    <strong>Total Cycles:</strong> <span id="string_totalCycles">0</span><br>
      <strong>Current Cycle:</strong> 
      <span id="string_currentCycle">0</span>
      <!-- Bargraph next to current cycle -->
      <div class="bargraph-container">
        <div id="string_barFill" class="bargraph-fill"></div>
      </div>
      <span id="string_barPercent" class="bargraph-percent">0%</span>
    <br>
    <strong>Forward Duration:</strong> <span id="string_forwardDuration">0</span><br>
    <strong>Backward Duration:</strong> <span id="string_backwardDuration">0</span><br>
    
    <!-- Cylinder -->
    <div class="cylinder-wrapper">
      <span id="cylinder" class="cylinder">⬇️</span>
      <span id="cylinderLabel">Cylinder Down</span>
    </div>
    
    <!-- Stations -->
    <div class="string_stations">
      <div class="string_station"><span id="string_station1" class="indicator led-off"></span> S1</div>
      <div class="string_station"><span id="string_station2" class="indicator led-off"></span> S2</div>
      <div class="string_station"><span id="string_station3" class="indicator led-off"></span> S3</div>
      <div class="string_station"><span id="string_station4" class="indicator led-off"></span> S4</div>
      <div class="string_station"><span id="string_station5" class="indicator led-off"></span> S5</div>
    </div>
  </div>
</div>
<div id="tab2" class="tabcontent">
  <h2>Tab 2</h2>
  <p>Reserved for future monitoring.</p>
</div>
<div id="tab3" class="tabcontent">
  <h2>Tab 3</h2>
  <p>Reserved for future monitoring.</p>
</div>
  
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // --- Tab switching ---
  function openTab(evt, tabName) {
    document.querySelectorAll(".tabcontent").forEach(tc => tc.style.display = "none");
    document.querySelectorAll(".tablink").forEach(tl => tl.classList.remove("active"));
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add("active");
  }

  // --- State variables ---
  let string_testRunning = false;
  let string_cylinderUp = false;
  let string_totalCycles = 0;
  let string_currentCycle = 0;
  let string_forwardDuration = 0;
  let string_backwardDuration = 0;
  let string_stations = [false, false, false, false, false];
  let string_errorMessage = 0;

  // --- Update UI ---
  function updateUI() {
    const string_powerIcon = document.getElementById("string_powerIcon");
    const string_powerLabel = document.getElementById("string_powerLabel");
    if (string_powerIcon && string_powerLabel) {
      if (string_testRunning) {
        string_powerIcon.className = "power-icon power-on";
        string_powerLabel.textContent = "Test ON";
      } else {
        string_powerIcon.className = "power-icon power-off";
        string_powerLabel.textContent = "Test OFF";
      }
    }

    const errorPanel = document.querySelector(".error-panel");
    const errorLabel = document.getElementById("errorLabel");
    if (errorPanel && errorLabel) {
      if (string_errorMessage == 0) {
        errorPanel.style.display = "none";
      } else {
        errorPanel.style.display = "flex";
        switch(string_errorMessage) {
          case 1: errorLabel.textContent = "Station 1 detached"; break;
          case 2: errorLabel.textContent = "Station 2 detached"; break;
          case 3: errorLabel.textContent = "Station 3 detached"; break;
          case 4: errorLabel.textContent = "Station 4 detached"; break;
          case 5: errorLabel.textContent = "Station 5 detached"; break;
          default: errorLabel.textContent = "Unknown Error";
        }
      }
    }

    const cyl = document.getElementById("cylinder");
    const cylLabel = document.getElementById("cylinderLabel");
    if (cyl && cylLabel) {
      if (string_cylinderUp) {
        cyl.textContent = "⬆️";
        cylLabel.textContent = "Cylinder Up";
      } else {
        cyl.textContent = "⬇️";
        cylLabel.textContent = "Cylinder Down";
      }
    }

    const totalEl = document.getElementById("string_totalCycles");
    const currentEl = document.getElementById("string_currentCycle");
    const forwardEl = document.getElementById("string_forwardDuration");
    const backwardEl = document.getElementById("string_backwardDuration");
    if (totalEl) totalEl.textContent = string_totalCycles;
    if (currentEl) currentEl.textContent = string_currentCycle;
    if (forwardEl) forwardEl.textContent = string_forwardDuration;
    if (backwardEl) backwardEl.textContent = string_backwardDuration;

    const string_barFill = document.getElementById("string_barFill");
    const barPercent = document.getElementById("string_barPercent");
    if (string_barFill && string_barPercent) {
      if (string_totalCycles > 0) {
        const percent = Math.min(100, (string_currentCycle / string_totalCycles) * 100);
        string_barFill.style.width = percent + "%";
        barPercent.textContent = Math.round(percent) + "%";
      } else {
        string_barFill.style.width = "0%";
        string_barPercent.textContent = "0%";
      }
    }

    string_stations.forEach((active, idx) => {
      const el = document.getElementById(`string_station${idx+1}`);
      if (el) {
        el.className = active ? "indicator led-on" : "indicator led-off";
      }
    });
  }
  // --- MQTT Setup ---
  const broker = "wss://test.mosquitto.org:8081"; // secure WebSocket port
  const topic = "esp32/peyman/test";
  let client;

  function initMQTT() {
    console.log("Connecting to MQTT broker...");
    client = mqtt.connect(broker);
    client.on("connect", () => {
      console.log("Connected to MQTT broker");
      client.subscribe(topic, (err) => {
        if (err) {
          console.error("Subscribe error:", err);
        } else {
          console.log("Subscribed to", topic);
        }
      });
    });

    client.on("message", (receivedTopic, message) => {
       // console.log("Raw message:", message.toString());
      if (receivedTopic === topic) {
        try {
          const data = JSON.parse(message.toString());
          // console.log(message.toString());
          console.log(data.toString());
          if ("string_tR" in data) string_testRunning = data.string_tR;
          if ("string_cUp" in data) string_cylinderUp = data.string_cUp;
          if ("string_totC" in data) string_totalCycles = data.string_totC;
          if ("string_curC" in data) string_currentCycle = data.string_curC;
          if ("string_fwd" in data) string_forwardDuration = data.string_fwd;
          if ("string_bwd" in data) string_backwardDuration = data.string_bwd;
          if ("string_sts" in data && Array.isArray(data.string_sts)) string_stations = data.string_sts;
          if ("string_err" in data) string_errorMessage = data.string_err;
          updateUI();
        } catch (err) {
          console.error("Invalid JSON:", message.toString());
        }
      }
    });

    client.on("error", (err) => {
      console.error("MQTT error:", err);
    });

    client.on("close", () => {
      console.log("MQTT connection closed, retrying...");
      setTimeout(initMQTT, 3000);
    });
  }
  // --- Initialize ---
  window.addEventListener("load", () => {
  try {
    initMQTT();
  } catch (err) {
    console.error("MQTT init failed:", err);
  }
  updateUI();
});
</script>
</body>
</html>

